<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jazz Session Manager</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #2c3e50; margin-top: 5px; }
        
        .reset-btn { background: none; border: none; color: #bdc3c7; font-size: 11px; cursor: pointer; text-decoration: underline; padding: 5px; }
        .reset-btn:hover { color: #e74c3c; }

        .container { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1000px; margin: 0 auto; }
        .panel { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1; min-width: 300px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; transition: all 0.2s ease; }
        button:hover { background-color: #2980b9; }
        button:active { transform: scale(0.97); } 
        
        .full-width-btn { width: 100%; font-weight: bold; }
        .btn-success-anim { background-color: #2ecc71 !important; }
        
        .generate-btn { background-color: #e74c3c; font-weight: bold; width: 100%; transition: all 0.2s ease; }
        .generate-btn:hover { background-color: #c0392b; }
        .confirm-btn { background-color: #27ae60; font-weight: bold; margin-top: 20px; width: 100%; transition: all 0.2s ease; }
        .confirm-btn:hover { background-color: #2ecc71; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle; }
        th { background-color: #f2f2f2; }
        .time-cell { font-family: monospace; color: #7f8c8d; width: 50px; }
        
        @keyframes flashHighlight {
            0% { background-color: #a2d9ce; }
            100% { background-color: transparent; }
        }
        .highlight-row td { animation: flashHighlight 1.5s ease-out; }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-down { animation: fadeInDown 0.4s ease-out; }

        @keyframes flashHistory {
            0% { background-color: #d1f2eb; border-color: #1abc9c; transform: scale(1.02); box-shadow: 0 8px 15px rgba(26, 188, 156, 0.3); }
            100% { background-color: #f9f9f9; border-color: #eee; transform: scale(1); box-shadow: none; }
        }
        .history-flash { animation: flashHistory 0.6s ease-out; }
        
        .small-btn { padding: 4px 8px; font-size: 0.85em; margin: 0 2px; border-radius: 3px; cursor: pointer; border: none; color: white; transition: background-color 0.2s ease; }
        .btn-red { background-color: #e74c3c; }
        .btn-red:hover { background-color: #c0392b; }
        .btn-gray { background-color: #95a5a6; }
        .btn-gray:hover { background-color: #7f8c8d; }
        .btn-green { background-color: #2ecc71; }
        .btn-green:hover { background-color: #27ae60; }
        .btn-yellow { background-color: #f1c40f; color: #333; }
        .btn-yellow:hover { background-color: #f39c12; }
        
        .session-result { background-color: #e8f8f5; border: 2px solid #1abc9c; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .edit-row { display: flex; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .edit-row:last-child { border-bottom: none; }
        .instrument-label { font-weight: bold; display: inline-block; width: 90px; color: #7f8c8d; }
        
        .edit-select { flex: 1; padding: 6px; font-size: 16px; background-color: #fff; transition: background-color 0.2s ease; }
        .edit-select.empty-select { background-color: #dcdde1; color: #7f8c8d; }
        
        .history-item { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-top: 15px; border-radius: 6px; transition: 0.3s; }
        .history-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #bdc3c7; padding-bottom: 5px; margin-bottom: 10px; }
        .history-title { font-weight: bold; color: #2c3e50; font-size: 1.1em; }
        .history-members { margin-bottom: 10px; line-height: 1.6; padding: 5px; border: 1px dashed transparent; border-radius: 4px; font-size: 16px; }
        .history-members[contenteditable="true"]:hover { border-color: #3498db; background-color: #fff; cursor: text; }
        .history-members[contenteditable="true"]:focus { border-color: #3498db; background-color: #fff; outline: none; }
        
        .memo-input { background-color: #fff; border: 1px dashed #95a5a6; padding: 8px; width: 100%; box-sizing: border-box; border-radius: 4px; font-size: 16px; transition: border-color 0.3s; }
        .memo-input:focus { border: 1px solid #3498db; outline: none; border-style: solid; }

        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 5px; }
        .setting-item { display: flex; align-items: center; background: #ecf0f1; padding: 8px; border-radius: 4px; }
        .setting-item .instrument-label { width: 60px; font-size: 0.9em; }
        .setting-item select { padding: 4px; font-size: 16px; flex: 1; }
        .settings-title { display: block; margin-top: 15px; margin-bottom: 5px; color: #34495e; font-size: 1em; font-weight: bold; border-left: 4px solid #3498db; padding-left: 8px;}
        .status-break { background-color: #fcf3cf; color: #7f8c8d; }
        
        .info-box { background-color: #e8f4f8; border-left: 4px solid #3498db; padding: 10px; font-size: 0.85em; color: #2c3e50; margin-bottom: 10px; border-radius: 0 4px 4px 0; line-height: 1.5; }
        .text-center { text-align: center; }
    </style>
</head>
<body>

    <h1>Jazz Session Manager</h1>
    
    <p style="text-align: left; color: #7f8c8d; font-size: 0.95em; margin-top: -5px; margin-bottom: 20px; padding: 0 10px;">
        ã“ã‚Œã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ›ã‚¹ãƒˆã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹WEBã‚¢ãƒ—ãƒªã§ã™ã€‚å‚åŠ è€…æƒ…å ±ã‚’å…¥åŠ›ã„ãŸã ã‘ã‚Œã°ãƒ¡ãƒ³ãƒãƒ¼ç·¨æˆã‚’ææ¡ˆã—ã¾ã™ã€‚
    </p>

    <div class="container">

        <div class="panel" style="flex-basis: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <h2 style="margin-top: 0; font-size: 1.2em;">âš™ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š</h2>
                <button class="reset-btn" onclick="clearAllData()">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <span class="settings-title">ğŸ‘¥ ç·¨æˆæ æ•°ï¼ˆä½•äººã§çµ„ã‚€ã‹ï¼‰</span>
            <div class="settings-grid">
                <div class="setting-item">
                    <span class="instrument-label">ãƒ•ãƒ­ãƒ³ãƒˆ</span>
                    <select id="count-ãƒ•ãƒ­ãƒ³ãƒˆ">
                        <option value="0">0äºº</option>
                        <option value="1">1äºº</option>
                        <option value="2" selected>2äºº</option>
                        <option value="3">3äºº</option>
                        <option value="4">4äºº</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span class="instrument-label">ã‚®ã‚¿ãƒ¼</span>
                    <select id="count-ã‚®ã‚¿ãƒ¼">
                        <option value="0">0äºº</option>
                        <option value="1" selected>1äºº</option>
                        <option value="2">2äºº</option>
                    </select>
                </div>
            </div>

            <span class="settings-title">ğŸ”„ äº¤ä»£ãƒ«ãƒ¼ãƒ«ï¼ˆä½•æ›²é€£ç¶šã§å›ã™ã‹ï¼‰</span>
            <div class="settings-grid">
                <div class="setting-item"><span class="instrument-label">ãƒ•ãƒ­ãƒ³ãƒˆ</span><select id="rot-ãƒ•ãƒ­ãƒ³ãƒˆ"><option value="1">1æ›²äº¤ä»£</option><option value="2">2æ›²é€£ç¶š</option><option value="3">3æ›²é€£ç¶š</option></select></div>
                <div class="setting-item"><span class="instrument-label">ãƒ”ã‚¢ãƒ</span><select id="rot-ãƒ”ã‚¢ãƒ"><option value="1">1æ›²äº¤ä»£</option><option value="2">2æ›²é€£ç¶š</option><option value="3">3æ›²é€£ç¶š</option></select></div>
                <div class="setting-item"><span class="instrument-label">ã‚®ã‚¿ãƒ¼</span><select id="rot-ã‚®ã‚¿ãƒ¼"><option value="1">1æ›²äº¤ä»£</option><option value="2">2æ›²é€£ç¶š</option><option value="3">3æ›²é€£ç¶š</option></select></div>
                <div class="setting-item"><span class="instrument-label">ãƒ™ãƒ¼ã‚¹</span><select id="rot-ãƒ™ãƒ¼ã‚¹"><option value="1">1æ›²äº¤ä»£</option><option value="2">2æ›²é€£ç¶š</option><option value="3">3æ›²é€£ç¶š</option></select></div>
                <div class="setting-item"><span class="instrument-label">ãƒ‰ãƒ©ãƒ </span><select id="rot-ãƒ‰ãƒ©ãƒ "><option value="1">1æ›²äº¤ä»£</option><option value="2">2æ›²é€£ç¶š</option><option value="3">3æ›²é€£ç¶š</option></select></div>
                <div class="setting-item"><span class="instrument-label">ãã®ä»–</span><select id="rot-ãã®ä»–"><option value="1">1æ›²äº¤ä»£</option><option value="2">2æ›²é€£ç¶š</option><option value="3">3æ›²é€£ç¶š</option></select></div>
            </div>
        </div>

        <div class="panel">
            <h2>å‚åŠ è€…ã‚¨ãƒ³ãƒˆãƒªãƒ¼</h2>
            <div class="form-group">
                <label for="name">åå‰</label>
                <input type="text" id="name" placeholder="ä¾‹: å±±ç”°å¤ªéƒ (Enterã§è¿½åŠ )">
            </div>
            <div class="form-group">
                <label for="instrument">æ¥½å™¨</label>
                <select id="instrument">
                    <option value="ãƒ•ãƒ­ãƒ³ãƒˆ">ãƒ•ãƒ­ãƒ³ãƒˆ</option>
                    <option value="ãƒ”ã‚¢ãƒ">ãƒ”ã‚¢ãƒ</option>
                    <option value="ã‚®ã‚¿ãƒ¼">ã‚®ã‚¿ãƒ¼</option>
                    <option value="ãƒ™ãƒ¼ã‚¹">ãƒ™ãƒ¼ã‚¹</option>
                    <option value="ãƒ‰ãƒ©ãƒ ">ãƒ‰ãƒ©ãƒ </option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </select>
            </div>
            <button id="add-btn" class="full-width-btn" onclick="addParticipant()">è¿½åŠ ã™ã‚‹</button>
        </div>

        <div class="panel" style="flex: 2;">
            <h2>ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸€è¦§ (<span id="total-count">0</span>å)</h2>
            
            <div class="info-box">
                <b>ğŸ’¡ åŸºæº–å›æ•°ã«ã¤ã„ã¦</b><br>
                é¸å‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å…¬å¹³ã«ã™ã‚‹ãŸã‚ã®å†…éƒ¨ã‚¹ã‚³ã‚¢ã§ã™ã€‚é…ã‚Œã¦æ¥ãŸäººãŒé€£ç¶šã§é¸ã°ã‚Œã™ãã‚‹ã®ã‚’é˜²ããŸã‚ã€é€”ä¸­å‚åŠ è€…ã¯è‡ªå‹•çš„ã«ã€ŒåŒã˜æ¥½å™¨ã®æœ€å°å›æ•°ã€ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ã‚ˆã†èª¿æ•´ã•ã‚Œã¾ã™ã€‚
            </div>

            <table id="participant-table">
                <thead>
                    <tr>
                        <th>å—ä»˜</th>
                        <th>åå‰</th>
                        <th>æ¥½å™¨</th>
                        <th>çŠ¶æ…‹</th>
                        <th class="text-center">å®Ÿæ¼”å¥</th>
                        <th class="text-center">åŸºæº–å›æ•°(èª¿æ•´)</th>
                        <th>å‰Šé™¤</th>
                    </tr>
                </thead>
                <tbody id="participant-list">
                </tbody>
            </table>
            <br>
            <button id="gen-btn" class="generate-btn" onclick="generateSession()">æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆ</button>
        </div>
    </div>

    <div class="container" style="margin-top: 20px;">
        <div class="panel" id="result-panel" style="display: none;">
            <h2>æ¬¡ã«æ¼”å¥ã™ã‚‹ç·¨æˆ (ãƒãƒ‹ãƒ¥ã‚¢ãƒ«èª¿æ•´)</h2>
            <p style="font-size: 0.9em; color: #7f8c8d;">â€»å¿…è¦ã«å¿œã˜ã¦ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…¥ã‚Œæ›¿ãˆã¦ã‹ã‚‰ã€Œç¢ºå®šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
            <div id="session-editor" class="session-result"></div>
            <button id="conf-btn" class="confirm-btn" onclick="confirmSession()">ã“ã®ç·¨æˆã§ç¢ºå®šã—ã¦å±¥æ­´ã«è¿½åŠ </button>
        </div>

        <div class="panel" id="history-panel" style="display: none;">
            <h2>ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´</h2>
            <p style="font-size: 0.9em; color: #7f8c8d;">â€»å±¥æ­´ã®ãƒ¡ãƒ³ãƒãƒ¼åéƒ¨åˆ†ã¯ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç›´æ¥æ–‡å­—ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
            <div id="history-output"></div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 40px; margin-bottom: 30px;">
        <p style="font-size: 0.85em; color: #7f8c8d;">ğŸ’¡ ã‚¢ãƒ—ãƒªãŒå½¹ã«ç«‹ã£ãŸã‚‰ã€é–‹ç™ºã®å¿œæ´ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼</p>
        <a href="https://ofuse.me/9ca24bdc" target="_blank" style="display: inline-block; background-color: #1abc9c; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s ease;">
            â˜•ï¸ é–‹ç™ºè€…ã‚’å¿œæ´ã™ã‚‹ï¼ˆæŠ•ã’éŠ­ãƒ»ã‚µãƒãƒ¼ãƒˆï¼‰
        </a>
    </div>

    <script>
        let participants = [];
        let sessionCounter = 0;
        let sessionHistoriesData = []; 

        // â¬‡ï¸ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½ â¬‡ï¸
        const STORAGE_KEY = 'jazzSessionApp_SaveData';

        function saveData() {
            const dataToSave = {
                participants: participants,
                sessionCounter: sessionCounter,
                sessionHistoriesData: sessionHistoriesData
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }

        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                participants = data.participants || [];
                sessionCounter = data.sessionCounter || 0;
                sessionHistoriesData = data.sessionHistoriesData || [];

                updateTable();
                restoreHistoryUI();
            }
        }

        function restoreHistoryUI() {
            if (sessionHistoriesData.length > 0) {
                document.getElementById('history-panel').style.display = 'block';
                const historyOutput = document.getElementById('history-output');
                historyOutput.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
                
                // å¤ã„é †(é…åˆ—ã®æœ€åˆ)ã‹ã‚‰è¿½åŠ ã—ã¦ã„ãã“ã¨ã§ã€æ–°ã—ã„ã‚‚ã®ãŒä¸Š(prepend)ã«ãªã‚‹
                sessionHistoriesData.forEach(h => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.id = h.id;
                    
                    historyItem.innerHTML = `
                        <div class="history-header">
                            <div class="history-title">ç¬¬${h.sessionNumber}å›</div>
                            <button class="small-btn btn-red" onclick="removeHistory('${h.id}')">å±¥æ­´ã‚’å‰Šé™¤</button>
                        </div>
                        <div class="history-members" contenteditable="true" onblur="updateHistoryHtml('${h.id}', this.innerHTML)" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†ã§ãã¾ã™">${h.membersHtml}</div>
                        <input type="text" class="memo-input" placeholder="ãƒ¡ãƒ¢ï¼ˆæ¼”å¥ã—ãŸæ›²åãªã©ï¼‰" value="${h.memo || ''}" oninput="updateHistoryMemo('${h.id}', this.value)">
                    `;
                    historyOutput.prepend(historyItem);
                });
            }
        }

        function clearAllData() {
            if (confirm("å‚åŠ è€…æƒ…å ±ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ãªã©ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚")) {
                localStorage.removeItem(STORAGE_KEY);
                participants = [];
                sessionCounter = 0;
                sessionHistoriesData = [];
                
                updateTable();
                document.getElementById('history-output').innerHTML = '';
                document.getElementById('history-panel').style.display = 'none';
                document.getElementById('result-panel').style.display = 'none';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
        window.onload = loadData;
        // â¬†ï¸ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½ â¬†ï¸

        document.getElementById('name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addParticipant();
            }
        });

        function addParticipant() {
            const nameInput = document.getElementById('name');
            const name = nameInput.value.trim();
            const instrument = document.getElementById('instrument').value;
            
            if (!name) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            const entryTimestamp = now.getTime();

            let initialPlayCount = 0;
            const sameInstMembers = participants.filter(p => p.instrument === instrument);
            if (sameInstMembers.length > 0) {
                initialPlayCount = Math.min(...sameInstMembers.map(p => p.playCount));
            }

            const newId = entryTimestamp.toString() + Math.floor(Math.random() * 1000);

            participants.push({ 
                id: newId, 
                name: name, 
                instrument: instrument, 
                playCount: initialPlayCount,
                actualPlayCount: 0,
                lastPlayedSession: 0, 
                currentConsecutiveCount: 0,
                entryTime: entryTimestamp, 
                entryTimeString: timeString,
                status: 'active'
            });
            
            const addBtn = document.getElementById('add-btn');
            const originalText = "è¿½åŠ ã™ã‚‹";
            addBtn.innerText = "âœ¨ è¿½åŠ ã—ã¾ã—ãŸï¼";
            addBtn.classList.add('btn-success-anim');
            setTimeout(() => {
                addBtn.innerText = originalText;
                addBtn.classList.remove('btn-success-anim');
            }, 1200);

            nameInput.value = '';
            nameInput.focus();
            updateTable(newId);
            saveData(); // ä¿å­˜
        }

        function removeParticipant(id) {
            if (confirm("ã“ã®å‚åŠ è€…ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ä¸€æ™‚çš„ãªé›¢å¸­ã®å ´åˆã¯ã€Œä¼‘æ†©ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚")) {
                participants = participants.filter(p => p.id !== id);
                updateTable();
                saveData(); // ä¿å­˜
            }
        }

        function toggleStatus(id) {
            const p = participants.find(p => p.id === id);
            if (p) {
                p.status = (p.status === 'active') ? 'break' : 'active';
                updateTable();
                saveData(); // ä¿å­˜
            }
        }

        function adjustCount(id, delta) {
            const p = participants.find(p => p.id === id);
            if (p) {
                p.playCount += delta;
                if (p.playCount < 0) p.playCount = 0;
                updateTable();
                saveData(); // ä¿å­˜
            }
        }

        function updateTable(highlightId = null) {
            const tbody = document.getElementById('participant-list');
            tbody.innerHTML = '';

            const instrumentOrder = { "ãƒ•ãƒ­ãƒ³ãƒˆ": 1, "ãƒ”ã‚¢ãƒ": 2, "ã‚®ã‚¿ãƒ¼": 3, "ãƒ™ãƒ¼ã‚¹": 4, "ãƒ‰ãƒ©ãƒ ": 5, "ãã®ä»–": 6 };

            const sortedParticipants = [...participants].sort((a, b) => {
                const orderA = instrumentOrder[a.instrument] || 99;
                const orderB = instrumentOrder[b.instrument] || 99;
                
                if (orderA !== orderB) {
                    return orderA - orderB;
                }
                return a.entryTime - b.entryTime;
            });

            sortedParticipants.forEach(p => {
                const tr = document.createElement('tr');
                if (p.status === 'break') tr.className = 'status-break'; 
                if (p.id === highlightId) tr.classList.add('highlight-row');
                
                const statusBtn = p.status === 'active' 
                    ? `<button class="small-btn btn-green" onclick="toggleStatus('${p.id}')">ğŸŸ¢ å‚åŠ ä¸­</button>` 
                    : `<button class="small-btn btn-yellow" onclick="toggleStatus('${p.id}')">ğŸŸ¡ ä¼‘æ†©ä¸­</button>`;

                tr.innerHTML = `
                    <td class="time-cell">${p.entryTimeString}</td>
                    <td>${p.name}</td>
                    <td>${p.instrument}</td>
                    <td>${statusBtn}</td>
                    <td class="text-center"><b>${p.actualPlayCount}å›</b></td>
                    <td class="text-center">
                        <button class="small-btn btn-gray" onclick="adjustCount('${p.id}', -1)">-</button>
                        ${p.playCount}
                        <button class="small-btn btn-gray" onclick="adjustCount('${p.id}', 1)">+</button>
                    </td>
                    <td>
                        <button class="small-btn btn-red" onclick="removeParticipant('${p.id}')">å‰Šé™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('total-count').innerText = participants.length;
        }

        function getSelectOptionsHTML(selectedParticipantId = "") {
            let html = `<option value="" style="background-color: #dcdde1;">-- ä¸åœ¨ / é¸æŠãªã— --</option>`;
            const instruments = ["ãƒ•ãƒ­ãƒ³ãƒˆ", "ãƒ”ã‚¢ãƒ", "ã‚®ã‚¿ãƒ¼", "ãƒ™ãƒ¼ã‚¹", "ãƒ‰ãƒ©ãƒ ", "ãã®ä»–"];
            instruments.forEach(inst => {
                const groupMembers = participants.filter(p => p.instrument === inst);
                if (groupMembers.length > 0) {
                    html += `<optgroup label="${inst}">`;
                    groupMembers.forEach(p => {
                        const selected = (p.id === selectedParticipantId) ? "selected" : "";
                        const justPlayedMark = (p.lastPlayedSession === sessionCounter && sessionCounter > 0) ? ` [é€£:${p.currentConsecutiveCount}]` : "";
                        const statusMark = p.status === 'break' ? ` ã€ä¼‘æ†©ä¸­ã€‘` : "";
                        html += `<option value="${p.id}" ${selected} style="background-color: #fff;">${p.name} (å®Ÿæ¼”å¥:${p.actualPlayCount}å›)${justPlayedMark}${statusMark}</option>`;
                    });
                    html += `</optgroup>`;
                }
            });
            return html;
        }

        function generateSession() {
            const activeParticipants = participants.filter(p => p.status === 'active');
            if (activeParticipants.length === 0) { alert("ç¾åœ¨å‚åŠ ä¸­ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚"); return; }

            const genBtn = document.getElementById('gen-btn');
            const origGenText = "æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆ";
            genBtn.innerText = "âœ¨ ç·¨æˆã‚’ä½œæˆã—ã¾ã—ãŸï¼";
            genBtn.classList.add('btn-success-anim');
            setTimeout(() => {
                genBtn.innerText = origGenText;
                genBtn.classList.remove('btn-success-anim');
            }, 1000);

            const frontReq = parseInt(document.getElementById('count-ãƒ•ãƒ­ãƒ³ãƒˆ').value);
            const guitarReq = parseInt(document.getElementById('count-ã‚®ã‚¿ãƒ¼').value);
            
            const rolesConfig = {
                "ãƒ•ãƒ­ãƒ³ãƒˆ": frontReq,
                "ãƒ”ã‚¢ãƒ": 1,
                "ã‚®ã‚¿ãƒ¼": guitarReq,
                "ãƒ™ãƒ¼ã‚¹": 1,
                "ãƒ‰ãƒ©ãƒ ": 1,
                "ãã®ä»–": 1
            };

            const rotationSettings = {
                "ãƒ•ãƒ­ãƒ³ãƒˆ": parseInt(document.getElementById('rot-ãƒ•ãƒ­ãƒ³ãƒˆ').value),
                "ãƒ”ã‚¢ãƒ": parseInt(document.getElementById('rot-ãƒ”ã‚¢ãƒ').value),
                "ã‚®ã‚¿ãƒ¼": parseInt(document.getElementById('rot-ã‚®ã‚¿ãƒ¼').value),
                "ãƒ™ãƒ¼ã‚¹": parseInt(document.getElementById('rot-ãƒ™ãƒ¼ã‚¹').value),
                "ãƒ‰ãƒ©ãƒ ": parseInt(document.getElementById('rot-ãƒ‰ãƒ©ãƒ ').value),
                "ãã®ä»–": parseInt(document.getElementById('rot-ãã®ä»–').value)
            };

            let autoSelected = { "ãƒ•ãƒ­ãƒ³ãƒˆ": [], "ãƒ”ã‚¢ãƒ": [], "ã‚®ã‚¿ãƒ¼": [], "ãƒ™ãƒ¼ã‚¹": [], "ãƒ‰ãƒ©ãƒ ": [], "ãã®ä»–": [] };
            
            activeParticipants.forEach(p => {
                if (p.lastPlayedSession === sessionCounter && sessionCounter > 0) {
                    const limit = rotationSettings[p.instrument] || 1;
                    if (p.currentConsecutiveCount < limit) {
                        if (autoSelected[p.instrument].length < rolesConfig[p.instrument]) {
                            autoSelected[p.instrument].push(p.id);
                        }
                    }
                }
            });

            const lockedIds = Object.values(autoSelected).flat();
            let pool = activeParticipants.filter(p => !lockedIds.includes(p.id));

            pool.sort((a, b) => {
                const aPlayedLast = (a.lastPlayedSession === sessionCounter && sessionCounter > 0) ? 1 : 0;
                const bPlayedLast = (b.lastPlayedSession === sessionCounter && sessionCounter > 0) ? 1 : 0;
                if (aPlayedLast !== bPlayedLast) return aPlayedLast - bPlayedLast;
                if (a.playCount !== b.playCount) return a.playCount - b.playCount;
                if (a.lastPlayedSession !== b.lastPlayedSession) return a.lastPlayedSession - b.lastPlayedSession;
                if (a.entryTime !== b.entryTime) return a.entryTime - b.entryTime;
                return Math.random() - 0.5;
            });

            ["ãƒ•ãƒ­ãƒ³ãƒˆ", "ãƒ”ã‚¢ãƒ", "ã‚®ã‚¿ãƒ¼", "ãƒ™ãƒ¼ã‚¹", "ãƒ‰ãƒ©ãƒ ", "ãã®ä»–"].forEach(inst => {
                const neededCount = rolesConfig[inst] - autoSelected[inst].length;
                const candidates = pool.filter(p => p.instrument === inst);
                for (let i = 0; i < neededCount; i++) {
                    if (candidates[i]) {
                        autoSelected[inst].push(candidates[i].id);
                    }
                }
            });

            const editor = document.getElementById('session-editor');
            editor.innerHTML = '';
            
            let slotCounter = 0;
            
            ["ãƒ•ãƒ­ãƒ³ãƒˆ", "ãƒ”ã‚¢ãƒ", "ã‚®ã‚¿ãƒ¼", "ãƒ™ãƒ¼ã‚¹", "ãƒ‰ãƒ©ãƒ ", "ãã®ä»–"].forEach(inst => {
                const count = rolesConfig[inst];
                for (let i = 0; i < count; i++) {
                    slotCounter++;
                    const defaultId = autoSelected[inst][i] || "";
                    const displayLabel = count > 1 ? `${inst}${i + 1}` : inst;
                    
                    const emptyClass = defaultId === "" ? "empty-select" : "";
                    
                    const row = document.createElement('div');
                    row.className = 'edit-row';
                    row.innerHTML = `<span class="instrument-label">${displayLabel}</span>` + 
                                    `<select id="slot-${slotCounter}" class="edit-select ${emptyClass}" data-inst="${inst}" data-label="${displayLabel}" onchange="this.classList.toggle('empty-select', this.value === '')">` +
                                    getSelectOptionsHTML(defaultId) +
                                    `</select>`;
                    editor.appendChild(row);
                }
            });

            const resultPanel = document.getElementById('result-panel');
            resultPanel.style.display = 'block';
            resultPanel.classList.remove('fade-in-down');
            void resultPanel.offsetWidth;
            resultPanel.classList.add('fade-in-down');

            setTimeout(() => {
                const confBtn = document.getElementById('conf-btn');
                if (confBtn) {
                    const rect = confBtn.getBoundingClientRect();
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetY = rect.bottom + scrollTop - window.innerHeight + 20;
                    
                    window.scrollTo({
                        top: targetY,
                        behavior: 'smooth'
                    });
                }
            }, 50);
        }

        // å±¥æ­´ã®ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ã‚’ä¿å­˜ã™ã‚‹ç”¨
        function updateHistoryHtml(id, newHtml) {
            const h = sessionHistoriesData.find(x => x.id === id);
            if (h) { h.membersHtml = newHtml; saveData(); }
        }

        // å±¥æ­´ã®ãƒ¡ãƒ¢ç·¨é›†ã‚’ä¿å­˜ã™ã‚‹ç”¨
        function updateHistoryMemo(id, newMemo) {
            const h = sessionHistoriesData.find(x => x.id === id);
            if (h) { h.memo = newMemo; saveData(); }
        }

        function removeHistory(historyId) {
            if(confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ã®æ¼”å¥å›æ•°ã‚„é€£ç¶šçŠ¶æ³ã‚‚å…ƒã«æˆ»ã‚Šã¾ã™ï¼‰")) {
                const historyData = sessionHistoriesData.find(h => h.id === historyId);
                if (historyData) {
                    historyData.membersState.forEach(savedState => {
                        const p = participants.find(p => p.id === savedState.id);
                        if (p) {
                            if (p.lastPlayedSession === historyData.sessionNumber) {
                                p.playCount = savedState.prevPlayCount;
                                p.actualPlayCount = savedState.prevActualPlayCount; 
                                p.currentConsecutiveCount = savedState.prevConsecutiveCount;
                                p.lastPlayedSession = savedState.prevLastPlayedSession;
                            } else {
                                if (p.playCount > 0) p.playCount--;
                                if (p.actualPlayCount > 0) p.actualPlayCount--;
                            }
                        }
                    });
                    if (historyData.sessionNumber === sessionCounter) {
                        sessionCounter--;
                    }
                    sessionHistoriesData = sessionHistoriesData.filter(h => h.id !== historyId);
                    updateTable();
                    saveData(); // ä¿å­˜
                }
                const el = document.getElementById(historyId);
                if (el) el.remove();
            }
        }

        function confirmSession() {
            const confBtn = document.getElementById('conf-btn');
            const originalText = confBtn.innerText;
            confBtn.innerText = "âœ… ç¢ºå®šã—ã¾ã—ãŸï¼";
            confBtn.classList.add('btn-success-anim');

            setTimeout(() => {
                confBtn.innerText = originalText;
                confBtn.classList.remove('btn-success-anim');
                
                let previousSessionCounter = sessionCounter;
                sessionCounter++;
                let confirmedMembers = [];
                let participatedMembersState = [];

                const selectEls = document.querySelectorAll('#session-editor .edit-select');
                
                selectEls.forEach(selectEl => {
                    const selectedId = selectEl.value;
                    const labelName = selectEl.dataset.label;
                    
                    if (selectedId !== "") {
                        const member = participants.find(p => p.id === selectedId);
                        if (member) {
                            confirmedMembers.push({ label: labelName, name: member.name, inst: member.instrument });
                            
                            participatedMembersState.push({
                                id: member.id,
                                prevPlayCount: member.playCount,
                                prevActualPlayCount: member.actualPlayCount,
                                prevConsecutiveCount: member.currentConsecutiveCount,
                                prevLastPlayedSession: member.lastPlayedSession
                            });
                            
                            member.playCount++; 
                            member.actualPlayCount++; 
                            
                            if (member.lastPlayedSession === previousSessionCounter && previousSessionCounter > 0) {
                                member.currentConsecutiveCount++;
                            } else {
                                member.currentConsecutiveCount = 1;
                            }
                            member.lastPlayedSession = sessionCounter;
                        }
                    }
                });

                updateTable();

                document.getElementById('history-panel').style.display = 'block';
                const historyOutput = document.getElementById('history-output');
                
                let membersHtml = confirmedMembers.map(m => `<b>[${m.label}]</b> ${m.name}`).join(' / ');
                if (confirmedMembers.length === 0) membersHtml = "ãƒ¡ãƒ³ãƒãƒ¼ãªã—";

                const historyId = `history-${Date.now()}`;
                
                // ä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿ã«HTMLã¨ãƒ¡ãƒ¢ã®ç©ºæ ã‚’è¿½åŠ 
                sessionHistoriesData.push({
                    id: historyId,
                    sessionNumber: sessionCounter,
                    membersState: participatedMembersState,
                    membersHtml: membersHtml,
                    memo: ""
                });

                const historyItem = document.createElement('div');
                historyItem.className = 'history-item history-flash';
                historyItem.id = historyId;
                
                historyItem.innerHTML = `
                    <div class="history-header">
                        <div class="history-title">ç¬¬${sessionCounter}å›</div>
                        <button class="small-btn btn-red" onclick="removeHistory('${historyId}')">å±¥æ­´ã‚’å‰Šé™¤</button>
                    </div>
                    <div class="history-members" contenteditable="true" onblur="updateHistoryHtml('${historyId}', this.innerHTML)" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆã‚’ç·¨é›†ã§ãã¾ã™">${membersHtml}</div>
                    <input type="text" class="memo-input" placeholder="ãƒ¡ãƒ¢ï¼ˆæ¼”å¥ã—ãŸæ›²åãªã©ï¼‰" oninput="updateHistoryMemo('${historyId}', this.value)">
                `;
                
                historyOutput.prepend(historyItem);
                document.getElementById('result-panel').style.display = 'none';

                saveData(); // ä¿å­˜

                setTimeout(() => {
                    const rect = historyItem.getBoundingClientRect();
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const targetY = rect.bottom + scrollTop - window.innerHeight + 20;
                    
                    window.scrollTo({
                        top: targetY,
                        behavior: 'smooth'
                    });
                }, 50);

            }, 300);
        }
    </script>
</body>
</html>